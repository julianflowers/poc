{
  "hash": "055ec79f169110938629e24431f9783c",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Smoking\"\nformat: html\neditor: visual\nexecute: \n  warning: false\n---\n\n\n\n\n## Workflow\n\n\n```{mermaid}\n%%| label: fig-workflow\n%%| fig-cap: \"Proposed workflow for calculating smoking rates\"\n\nflowchart TD\nA[Data] --> B[population data]\nA --> C[smoking data]\nC --> D[[reclassify directorate names to regions]] --> E[[calculate age bands]] --> F[[calculate smoking counts]]\nB --> G[[calculate age bands]] --> H[[calculate population counts]]\nH --> I[[join datasets]]\nF --> I\nI --> J[calculate rates and ci]\n\n```\n\n\n### Load census population and create age bands\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## create age band\n\npops <- setDT(pops)[, `:=` (`18-44`  = dplyr::between(age, 18, 44), `15+` = age >= 15, `80+` = age >= 80, age_band = cut(age, seq(0, 110, 5), right = FALSE))][]\n\npop_age <- pops[, .(n = .N, sumpops = sum(Population, na.rm = TRUE)), by = .(Region, age_band,  Gender)][order(age_band)]\n\npop1844F <- pops[, .(n = .N, sumpops = sum(Population, na.rm = TRUE)), by = .(Region, `18-44`,  Gender)][`18-44` == \"TRUE\" & Gender == \"Female\",]\n\npop15F <- pops[, .(n = .N, sumpops = sum(Population, na.rm = TRUE)), by = .(Region, `15+`,  Gender)][`15+` == \"TRUE\" & Gender == \"Female\",]\n```\n:::\n\n\n### Load smoking data and calculate age bands\n\nNote: it is not clear if the dummy data is a random sample of clinic attendance data.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsmok_age <- smoking[, `:=` (`18-44`  = dplyr::between(age, 18, 44), `15+` = age >= 15, `80+` = age >= 80, age_band = cut(age, seq(0, 110, 5), right = FALSE))][]\n\nsmok_age_bands <- smok_age[, .(n = .N, smokers = sum(n, na.rm = TRUE)), by = .(Region, age_band,  Gender)][order(age_band)]\n\nsmok1844F <- smok_age[, .(n = .N, smokers = sum(n, na.rm = TRUE)), by = .(Region, `18-44`,  Gender)][`18-44` == \"TRUE\" & Gender == \"female\",]\n\nsmok15F <- smok_age[, .(n = .N, smokers = sum(n, na.rm = TRUE)), by = .(Region, `15+`,  Gender)][`15+` == \"TRUE\" & Gender == \"female\",]\n```\n:::\n\n\n### Join datasets and calculate rates\n\nThis step uses Byar's method for confidence interval for rates\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsmok_rates <- pop1844F |>\n    left_join(smok1844F, by = \"Region\") |> \n    phe_rate(x = smokers, n = sumpops) \n\nsmok_rates |>\n    dplyr::select(Region, smokers, population = sumpops, value, lowercl, uppercl) |>\n    flextable::flextable()\n```\n\n::: {#fig-rate-1 .cell-output-display}\n\n```{=html}\n<div class=\"tabwid\"><style>.cl-50e2a90e{}.cl-50dbd26e{font-family:'Helvetica';font-size:11pt;font-weight:normal;font-style:normal;text-decoration:none;color:rgba(0, 0, 0, 1.00);background-color:transparent;}.cl-50df725c{margin:0;text-align:left;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-50df7266{margin:0;text-align:right;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-50df830a{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 1.5pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-50df8314{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 1.5pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-50df8315{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-50df831e{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-50df831f{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-50df8328{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}</style><table data-quarto-disable-processing='true' class='cl-50e2a90e'><thead><tr style=\"overflow-wrap:break-word;\"><th class=\"cl-50df830a\"><p class=\"cl-50df725c\"><span class=\"cl-50dbd26e\">Region</span></p></th><th class=\"cl-50df8314\"><p class=\"cl-50df7266\"><span class=\"cl-50dbd26e\">smokers</span></p></th><th class=\"cl-50df8314\"><p class=\"cl-50df7266\"><span class=\"cl-50dbd26e\">population</span></p></th><th class=\"cl-50df8314\"><p class=\"cl-50df7266\"><span class=\"cl-50dbd26e\">value</span></p></th><th class=\"cl-50df8314\"><p class=\"cl-50df7266\"><span class=\"cl-50dbd26e\">lowercl</span></p></th><th class=\"cl-50df8314\"><p class=\"cl-50df7266\"><span class=\"cl-50dbd26e\">uppercl</span></p></th></tr></thead><tbody><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-50df8315\"><p class=\"cl-50df725c\"><span class=\"cl-50dbd26e\">'Asir</span></p></td><td class=\"cl-50df831e\"><p class=\"cl-50df7266\"><span class=\"cl-50dbd26e\"></span></p></td><td class=\"cl-50df831e\"><p class=\"cl-50df7266\"><span class=\"cl-50dbd26e\">366,324</span></p></td><td class=\"cl-50df831e\"><p class=\"cl-50df7266\"><span class=\"cl-50dbd26e\"></span></p></td><td class=\"cl-50df831e\"><p class=\"cl-50df7266\"><span class=\"cl-50dbd26e\"></span></p></td><td class=\"cl-50df831e\"><p class=\"cl-50df7266\"><span class=\"cl-50dbd26e\"></span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-50df8315\"><p class=\"cl-50df725c\"><span class=\"cl-50dbd26e\">Al Bahah</span></p></td><td class=\"cl-50df831e\"><p class=\"cl-50df7266\"><span class=\"cl-50dbd26e\">28</span></p></td><td class=\"cl-50df831e\"><p class=\"cl-50df7266\"><span class=\"cl-50dbd26e\">61,969</span></p></td><td class=\"cl-50df831e\"><p class=\"cl-50df7266\"><span class=\"cl-50dbd26e\">45.183882</span></p></td><td class=\"cl-50df831e\"><p class=\"cl-50df7266\"><span class=\"cl-50dbd26e\">30.017729</span></p></td><td class=\"cl-50df831e\"><p class=\"cl-50df7266\"><span class=\"cl-50dbd26e\">65.30573</span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-50df8315\"><p class=\"cl-50df725c\"><span class=\"cl-50dbd26e\">Al Hudud ash Shamaliyah</span></p></td><td class=\"cl-50df831e\"><p class=\"cl-50df7266\"><span class=\"cl-50dbd26e\">4</span></p></td><td class=\"cl-50df831e\"><p class=\"cl-50df7266\"><span class=\"cl-50dbd26e\">70,149</span></p></td><td class=\"cl-50df831e\"><p class=\"cl-50df7266\"><span class=\"cl-50dbd26e\">5.702148</span></p></td><td class=\"cl-50df831e\"><p class=\"cl-50df7266\"><span class=\"cl-50dbd26e\">1.553643</span></p></td><td class=\"cl-50df831e\"><p class=\"cl-50df7266\"><span class=\"cl-50dbd26e\">14.59976</span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-50df8315\"><p class=\"cl-50df725c\"><span class=\"cl-50dbd26e\">Al Jawf</span></p></td><td class=\"cl-50df831e\"><p class=\"cl-50df7266\"><span class=\"cl-50dbd26e\">23</span></p></td><td class=\"cl-50df831e\"><p class=\"cl-50df7266\"><span class=\"cl-50dbd26e\">103,536</span></p></td><td class=\"cl-50df831e\"><p class=\"cl-50df7266\"><span class=\"cl-50dbd26e\">22.214495</span></p></td><td class=\"cl-50df831e\"><p class=\"cl-50df7266\"><span class=\"cl-50dbd26e\">14.077587</span></p></td><td class=\"cl-50df831e\"><p class=\"cl-50df7266\"><span class=\"cl-50dbd26e\">33.33412</span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-50df8315\"><p class=\"cl-50df725c\"><span class=\"cl-50dbd26e\">Al Madinah al Munawwarah</span></p></td><td class=\"cl-50df831e\"><p class=\"cl-50df7266\"><span class=\"cl-50dbd26e\"></span></p></td><td class=\"cl-50df831e\"><p class=\"cl-50df7266\"><span class=\"cl-50dbd26e\">387,944</span></p></td><td class=\"cl-50df831e\"><p class=\"cl-50df7266\"><span class=\"cl-50dbd26e\"></span></p></td><td class=\"cl-50df831e\"><p class=\"cl-50df7266\"><span class=\"cl-50dbd26e\"></span></p></td><td class=\"cl-50df831e\"><p class=\"cl-50df7266\"><span class=\"cl-50dbd26e\"></span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-50df8315\"><p class=\"cl-50df725c\"><span class=\"cl-50dbd26e\">Al Mintaqah ash Sharqiyah</span></p></td><td class=\"cl-50df831e\"><p class=\"cl-50df7266\"><span class=\"cl-50dbd26e\"></span></p></td><td class=\"cl-50df831e\"><p class=\"cl-50df7266\"><span class=\"cl-50dbd26e\">877,403</span></p></td><td class=\"cl-50df831e\"><p class=\"cl-50df7266\"><span class=\"cl-50dbd26e\"></span></p></td><td class=\"cl-50df831e\"><p class=\"cl-50df7266\"><span class=\"cl-50dbd26e\"></span></p></td><td class=\"cl-50df831e\"><p class=\"cl-50df7266\"><span class=\"cl-50dbd26e\"></span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-50df8315\"><p class=\"cl-50df725c\"><span class=\"cl-50dbd26e\">Al Qasim</span></p></td><td class=\"cl-50df831e\"><p class=\"cl-50df7266\"><span class=\"cl-50dbd26e\"></span></p></td><td class=\"cl-50df831e\"><p class=\"cl-50df7266\"><span class=\"cl-50dbd26e\">249,081</span></p></td><td class=\"cl-50df831e\"><p class=\"cl-50df7266\"><span class=\"cl-50dbd26e\"></span></p></td><td class=\"cl-50df831e\"><p class=\"cl-50df7266\"><span class=\"cl-50dbd26e\"></span></p></td><td class=\"cl-50df831e\"><p class=\"cl-50df7266\"><span class=\"cl-50dbd26e\"></span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-50df8315\"><p class=\"cl-50df725c\"><span class=\"cl-50dbd26e\">Ar Riyadh</span></p></td><td class=\"cl-50df831e\"><p class=\"cl-50df7266\"><span class=\"cl-50dbd26e\"></span></p></td><td class=\"cl-50df831e\"><p class=\"cl-50df7266\"><span class=\"cl-50dbd26e\">1,609,493</span></p></td><td class=\"cl-50df831e\"><p class=\"cl-50df7266\"><span class=\"cl-50dbd26e\"></span></p></td><td class=\"cl-50df831e\"><p class=\"cl-50df7266\"><span class=\"cl-50dbd26e\"></span></p></td><td class=\"cl-50df831e\"><p class=\"cl-50df7266\"><span class=\"cl-50dbd26e\"></span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-50df8315\"><p class=\"cl-50df725c\"><span class=\"cl-50dbd26e\">Ha'il</span></p></td><td class=\"cl-50df831e\"><p class=\"cl-50df7266\"><span class=\"cl-50dbd26e\">22</span></p></td><td class=\"cl-50df831e\"><p class=\"cl-50df7266\"><span class=\"cl-50dbd26e\">136,642</span></p></td><td class=\"cl-50df831e\"><p class=\"cl-50df7266\"><span class=\"cl-50dbd26e\">16.100467</span></p></td><td class=\"cl-50df831e\"><p class=\"cl-50df7266\"><span class=\"cl-50dbd26e\">10.086571</span></p></td><td class=\"cl-50df831e\"><p class=\"cl-50df7266\"><span class=\"cl-50dbd26e\">24.37741</span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-50df8315\"><p class=\"cl-50df725c\"><span class=\"cl-50dbd26e\">Jazan</span></p></td><td class=\"cl-50df831e\"><p class=\"cl-50df7266\"><span class=\"cl-50dbd26e\"></span></p></td><td class=\"cl-50df831e\"><p class=\"cl-50df7266\"><span class=\"cl-50dbd26e\">267,342</span></p></td><td class=\"cl-50df831e\"><p class=\"cl-50df7266\"><span class=\"cl-50dbd26e\"></span></p></td><td class=\"cl-50df831e\"><p class=\"cl-50df7266\"><span class=\"cl-50dbd26e\"></span></p></td><td class=\"cl-50df831e\"><p class=\"cl-50df7266\"><span class=\"cl-50dbd26e\"></span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-50df8315\"><p class=\"cl-50df725c\"><span class=\"cl-50dbd26e\">Makkah al Mukarramah</span></p></td><td class=\"cl-50df831e\"><p class=\"cl-50df7266\"><span class=\"cl-50dbd26e\"></span></p></td><td class=\"cl-50df831e\"><p class=\"cl-50df7266\"><span class=\"cl-50dbd26e\">1,507,301</span></p></td><td class=\"cl-50df831e\"><p class=\"cl-50df7266\"><span class=\"cl-50dbd26e\"></span></p></td><td class=\"cl-50df831e\"><p class=\"cl-50df7266\"><span class=\"cl-50dbd26e\"></span></p></td><td class=\"cl-50df831e\"><p class=\"cl-50df7266\"><span class=\"cl-50dbd26e\"></span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-50df8315\"><p class=\"cl-50df725c\"><span class=\"cl-50dbd26e\">Najran</span></p></td><td class=\"cl-50df831e\"><p class=\"cl-50df7266\"><span class=\"cl-50dbd26e\">82</span></p></td><td class=\"cl-50df831e\"><p class=\"cl-50df7266\"><span class=\"cl-50dbd26e\">105,915</span></p></td><td class=\"cl-50df831e\"><p class=\"cl-50df7266\"><span class=\"cl-50dbd26e\">77.420573</span></p></td><td class=\"cl-50df831e\"><p class=\"cl-50df7266\"><span class=\"cl-50dbd26e\">61.572876</span></p></td><td class=\"cl-50df831e\"><p class=\"cl-50df7266\"><span class=\"cl-50dbd26e\">96.10050</span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-50df831f\"><p class=\"cl-50df725c\"><span class=\"cl-50dbd26e\">Tabuk</span></p></td><td class=\"cl-50df8328\"><p class=\"cl-50df7266\"><span class=\"cl-50dbd26e\">291</span></p></td><td class=\"cl-50df8328\"><p class=\"cl-50df7266\"><span class=\"cl-50dbd26e\">163,453</span></p></td><td class=\"cl-50df8328\"><p class=\"cl-50df7266\"><span class=\"cl-50dbd26e\">178.032829</span></p></td><td class=\"cl-50df8328\"><p class=\"cl-50df7266\"><span class=\"cl-50dbd26e\">158.162585</span></p></td><td class=\"cl-50df8328\"><p class=\"cl-50df7266\"><span class=\"cl-50dbd26e\">199.70848</span></p></td></tr></tbody></table></div>\n```\n\n\nSmoking clinic attendance rates (18-44)\n:::\n\n```{.r .cell-code}\nsmok_rates |>\n    write_csv(\"data/smok_rates.csv\")\n   \nsmok_rates |>\n    ggplot() +\n    geom_col(aes(reorder(Region, value), value)) +\n    geom_linerange(aes(x = Region, ymin = lowercl, ymax = uppercl)) +\n    coord_flip() +\n    labs(x = \" \",\n         y = \"Rate per 100.000\")\n```\n\n::: {.cell-output-display}\n![Smoking clinic attendance rates (18-44)](smoking-poc_files/figure-html/fig-rate-1.png){#fig-rate-2 width=672}\n:::\n:::\n\n\n### Age-specific attendance rates\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsmok_age_agg <- smok_age_bands[, .(tot_smokers = sum(smokers)), by = .(age_band, Gender)][]\n\noptions(scipen = 999, digitds = 2)\n\n## m:f as smoking ratios\n\nsmok_rates_gender <- pop_age |>\n    dplyr::select(-Region) |>\n    mutate(Gender = recode(Gender, \"Female\" = \"female\", \"Male\" = \"male\")) |>\n    left_join(smok_age_agg, by = c(\"age_band\", \"Gender\")) |>\n    group_by(age_band, Gender) |>\n    reframe(nat_smok = sum(tot_smokers, na.rm = TRUE), \n           nat_pop = sum(sumpops)) |>\n    phe_rate(x = nat_smok, n = nat_pop) |> \n    mutate(value = ifelse(Gender == \"female\", -value, value)) |>\n    ggplot() +\n    geom_col(aes(age_band, value, fill = Gender)) +\n    coord_flip() +\n    scale_fill_manual(values = c(\"blue\", \"red\")) +\n    labs(x = \"\",  y = \"Attendance rate per 100000\")\n\nsmok_rates_gender    \n```\n\n::: {.cell-output-display}\n![](smoking-poc_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n\n```{.r .cell-code}\nsmok_gender_ratio <- pop_age |>\n    dplyr::select(-Region) |>\n    mutate(Gender = recode(Gender, \"Female\" = \"female\", \"Male\" = \"male\")) |>\n    left_join(smok_age_agg, by = c(\"age_band\", \"Gender\")) |>\n    group_by(age_band, Gender) |>\n    reframe(nat_smok = sum(tot_smokers, na.rm = TRUE), \n           nat_pop = sum(sumpops)) |>\n    phe_rate(x = nat_smok, n = nat_pop) |>\n    slice(7:36) |>\n    group_by(age_band) |>\n    reframe(ratio = value[2] / value[1]) |>\n    mutate(mean_ratio = mean(ratio))\n```\n:::\n\n\nThe relative attendance rate for males is 17.32 times that of females. Smoking clinic attendance rates could be used as a proxy for population smoking rates if the relationship between attendance and prevalence is known . For example, survey data suggests that KSA male smoking rates are around 20% which implies a female smoking rate based on 1.15%. In fact, available survey data (@algabbani2018), and estimates from the Global Burden of Disease ([@prevalen; @xiang2023]), suggest a smoking prevalence in females over 15 of 2%,\n",
    "supporting": [
      "smoking-poc_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"site_libs/tabwid-1.1.3/tabwid.css\" rel=\"stylesheet\" />\n<script src=\"site_libs/tabwid-1.1.3/tabwid.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}