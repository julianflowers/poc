{
  "hash": "7ad67186dbf869917a0624e7a3c1b781",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Data pre-processing\"\nformat: html\neditor: \n  markdown: \n    wrap: 72\nexecute:\n   cache: false\n   message: false\n   warning: false\n   freeze: auto\n---\n\n\n\n\n## Getting started\n\nThese pages set out the process for loading, cleaning, reshaping and\nrecoding provided datasets for calculating indicator values as a proof\nof concept, and creating a health profile from those indicators.\n\nTo facilitate reproducibility the analyses are written in R code in the\nform of a notebook and R scripts which do much of the pre-processing.\nThe full code is made available as a Github repository at\n<https://github.com/julianflowers/poc>. The files can be cloned\n(downloaded)\n\n-   In RStudio, go to “File > New Project”\n\n-   Click on “Version Control:\n\n-   Checkout a project from a version control repository”\n\n-   Click on “Git:\n\n-   Clone a project from a repository”\n\n-   Fill in the info: URL: use HTTPS address\n\n-   Create as a subdirectory of: Browse to where you would like to\n    create this folder\n\n### The indicators\n\n4 sets of indicators are used for this PoC:\n\n-   Methicillin resistant Staph aureus and 3rd generation cephalosporin\n    resistant E.coli - proportion of samples tested which are resistant\n\n-   Flu vaccination coverage rates\n\n-   Smoking rates in women\n\n-   Injury admission rates\n\nFully specifying the indicators\n\n1.  The proportion of blood samples which grow either Staph aureaus\n    or E. coli, which are tested for antibiotic sensitivity and which\n    are found to be resistant to oxacllin or 3rd generation\n    cephalosporins respectively for time period X to Y, stratified by\n    \\[area\\] / \\[time period\\] / \\[age group\\] / \\[gender\\]\n\n2.  The proportion of the population which has been vaccinated against\n    flu for the time period X to Y stratified by \\[area\\] / \\[time\n    period\\] / \\[age group\\] / \\[gender\\]\n\n3.  The rate of smoking in women aged 15+ / 18-44, per 100,000 female\n    population for the time period X to Y stratified by \\[area\\] /\n    \\[time period\\] / \\[age group\\] / \\[gender\\]\n\n4.  The rate of hospitalisation for injury for the time period X to Y\n    stratified by \\[area\\] / \\[time period\\] / \\[age group\\] /\n    \\[gender\\]\n\n### Pre-processing script\n\nAs a first step we will run a script which does a number of things.\n\n1.  Imports the datasets for each indicator\n\n2.  Loads KSA 2022 census data by age, gender and\n    region[^getting-started-1]\n\n3.  Makes variable names consistent\n\n4.  Recodes `region` names so that they match the names used in the\n    Census 2022 data\n\n5.  Maps directorate names (used in smoking data) to\n    `region`[^getting-started-2]\n\n6.  Ensures numeric variables (e.g. age) are converted to numbers\n\n7.  Creates a set of intermediate data tables\n\n8.  Saves file of reshaped population data,\n\n[^getting-started-1]: Note. The census data was downloaded from\n    <https://tableau.saudicensus.sa/#/views/TA3-PopulationbydetailedAgebyRegionGovernorateNationalityandGenderAR_16850208449070/PopulationbydetailedAgebyRegionGovernorateNationalityandGenderARCSV.csv>\n    and variable and region names translated to English using ChatGPT4o\n\n[^getting-started-2]: This uses the spatial locations of smoking clinics\n    which include directorate names to map to KSA regional boundaries\n\nThe intermediate tables can be reused for further analysis and\ngenerating profiles.\n\nThe script can be run by typing\n\n\n\n````         \n```\n`source(\"~/proof-of-concept/scripts/pre-process.R\")`\n\n```\n````\n\nat the prompt in the console\n\nThis generates a set of objects in the R environment\n\n\n::: {.cell}\n\n```{.r .cell-code}\nobjects() \n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n [1] \"age_names\"                        \"area_names\"                      \n [3] \"census_names\"                     \"cnames\"                          \n [5] \"csv\"                              \"csvs\"                            \n [7] \"data\"                             \"dfs\"                             \n [9] \"dfs_3\"                            \"dfs_4\"                           \n[11] \"dfs1\"                             \"dfs2_agg\"                        \n[13] \"dfs3\"                             \"f_r\"                             \n[15] \"final_poc_data\"                   \"gender_names\"                    \n[17] \"get_coordinates_from_google_maps\" \"m_r\"                             \n[19] \"pop_agg\"                          \"pops\"                            \n[21] \"reg_dir_lu\"                       \"regional_counts\"                 \n[23] \"regional_counts_complete\"         \"RETICULATE_PYTHON\"               \n[25] \"sa_bound\"                         \"sa_shp\"                          \n[27] \"sa_shp_1\"                         \"sc_coords\"                       \n[29] \"sc_dir_links\"                     \"sc_dir_names\"                    \n[31] \"sc_ll\"                            \"sc_ll_sf\"                        \n[33] \"sc_loc\"                           \"scc_dir\"                         \n[35] \"shps\"                             \"smok_1\"                          \n[37] \"smok_agg\"                         \"tmpd\"                            \n[39] \"url\"                              \"xl\"                              \n[41] \"xls\"                             \n```\n\n\n:::\n:::\n\n\nObjects called `dfs` reflect pre-processing of the original datasets.\nObjects containing `names`, contain the different variables used for\nage, gender and area variables across datasets. Those called `sc` are\nused to map locations of smoking clinics as part of recoding\ndirectorates to regions for the smoking data (see below).\n\nThe object `regional_counts_complete` is a data frame of regional\nage_band, gender specific counts for each indicator and forms the basis\nof indicator generation. Note, this includes region-age-band-gender\ncombinations for which there is no data (because these combinations are\nnot present in the original data - although they maybe in the full\ndatasets).\n\n\n::: {#tbl-counts .cell .tbl-cap-location-bottom tbl-cap='Region age-band specific counts by gender and indicator'}\n\n```{.r .cell-code}\nregional_counts_complete |>\n    head() |>\n    flextable::flextable()\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"tabwid\"><style>.cl-e0e7bbbc{}.cl-e0e27242{font-family:'Helvetica';font-size:11pt;font-weight:normal;font-style:normal;text-decoration:none;color:rgba(0, 0, 0, 1.00);background-color:transparent;}.cl-e0e4911c{margin:0;text-align:left;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-e0e49126{margin:0;text-align:right;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-e0e4a2a6{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 1.5pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-e0e4a2b0{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 1.5pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-e0e4a2b1{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-e0e4a2ba{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-e0e4a2c4{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-e0e4a2c5{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}</style><table data-quarto-disable-processing='true' class='cl-e0e7bbbc'><thead><tr style=\"overflow-wrap:break-word;\"><th class=\"cl-e0e4a2a6\"><p class=\"cl-e0e4911c\"><span class=\"cl-e0e27242\">Region</span></p></th><th class=\"cl-e0e4a2a6\"><p class=\"cl-e0e4911c\"><span class=\"cl-e0e27242\">age_band</span></p></th><th class=\"cl-e0e4a2b0\"><p class=\"cl-e0e49126\"><span class=\"cl-e0e27242\">sum_f_Smoking</span></p></th><th class=\"cl-e0e4a2b0\"><p class=\"cl-e0e49126\"><span class=\"cl-e0e27242\">sum_f_flu</span></p></th><th class=\"cl-e0e4a2b0\"><p class=\"cl-e0e49126\"><span class=\"cl-e0e27242\">sum_f_injury</span></p></th><th class=\"cl-e0e4a2b0\"><p class=\"cl-e0e49126\"><span class=\"cl-e0e27242\">sum_m_Smoking</span></p></th><th class=\"cl-e0e4a2b0\"><p class=\"cl-e0e49126\"><span class=\"cl-e0e27242\">sum_m_flu</span></p></th><th class=\"cl-e0e4a2b0\"><p class=\"cl-e0e49126\"><span class=\"cl-e0e27242\">sum_m_injury</span></p></th></tr></thead><tbody><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-e0e4a2b1\"><p class=\"cl-e0e4911c\"><span class=\"cl-e0e27242\">`Asir</span></p></td><td class=\"cl-e0e4a2b1\"><p class=\"cl-e0e4911c\"><span class=\"cl-e0e27242\">[  0,  5)</span></p></td><td class=\"cl-e0e4a2ba\"><p class=\"cl-e0e49126\"><span class=\"cl-e0e27242\"></span></p></td><td class=\"cl-e0e4a2ba\"><p class=\"cl-e0e49126\"><span class=\"cl-e0e27242\">140</span></p></td><td class=\"cl-e0e4a2ba\"><p class=\"cl-e0e49126\"><span class=\"cl-e0e27242\">160</span></p></td><td class=\"cl-e0e4a2ba\"><p class=\"cl-e0e49126\"><span class=\"cl-e0e27242\"></span></p></td><td class=\"cl-e0e4a2ba\"><p class=\"cl-e0e49126\"><span class=\"cl-e0e27242\">26</span></p></td><td class=\"cl-e0e4a2ba\"><p class=\"cl-e0e49126\"><span class=\"cl-e0e27242\">0</span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-e0e4a2b1\"><p class=\"cl-e0e4911c\"><span class=\"cl-e0e27242\">`Asir</span></p></td><td class=\"cl-e0e4a2b1\"><p class=\"cl-e0e4911c\"><span class=\"cl-e0e27242\">[  5, 10)</span></p></td><td class=\"cl-e0e4a2ba\"><p class=\"cl-e0e49126\"><span class=\"cl-e0e27242\">0</span></p></td><td class=\"cl-e0e4a2ba\"><p class=\"cl-e0e49126\"><span class=\"cl-e0e27242\">7</span></p></td><td class=\"cl-e0e4a2ba\"><p class=\"cl-e0e49126\"><span class=\"cl-e0e27242\"></span></p></td><td class=\"cl-e0e4a2ba\"><p class=\"cl-e0e49126\"><span class=\"cl-e0e27242\">1</span></p></td><td class=\"cl-e0e4a2ba\"><p class=\"cl-e0e49126\"><span class=\"cl-e0e27242\">1</span></p></td><td class=\"cl-e0e4a2ba\"><p class=\"cl-e0e49126\"><span class=\"cl-e0e27242\"></span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-e0e4a2b1\"><p class=\"cl-e0e4911c\"><span class=\"cl-e0e27242\">`Asir</span></p></td><td class=\"cl-e0e4a2b1\"><p class=\"cl-e0e4911c\"><span class=\"cl-e0e27242\">[ 10, 15)</span></p></td><td class=\"cl-e0e4a2ba\"><p class=\"cl-e0e49126\"><span class=\"cl-e0e27242\">5</span></p></td><td class=\"cl-e0e4a2ba\"><p class=\"cl-e0e49126\"><span class=\"cl-e0e27242\">4</span></p></td><td class=\"cl-e0e4a2ba\"><p class=\"cl-e0e49126\"><span class=\"cl-e0e27242\"></span></p></td><td class=\"cl-e0e4a2ba\"><p class=\"cl-e0e49126\"><span class=\"cl-e0e27242\">355</span></p></td><td class=\"cl-e0e4a2ba\"><p class=\"cl-e0e49126\"><span class=\"cl-e0e27242\">2</span></p></td><td class=\"cl-e0e4a2ba\"><p class=\"cl-e0e49126\"><span class=\"cl-e0e27242\"></span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-e0e4a2b1\"><p class=\"cl-e0e4911c\"><span class=\"cl-e0e27242\">`Asir</span></p></td><td class=\"cl-e0e4a2b1\"><p class=\"cl-e0e4911c\"><span class=\"cl-e0e27242\">[ 15, 20)</span></p></td><td class=\"cl-e0e4a2ba\"><p class=\"cl-e0e49126\"><span class=\"cl-e0e27242\">39</span></p></td><td class=\"cl-e0e4a2ba\"><p class=\"cl-e0e49126\"><span class=\"cl-e0e27242\">13</span></p></td><td class=\"cl-e0e4a2ba\"><p class=\"cl-e0e49126\"><span class=\"cl-e0e27242\"></span></p></td><td class=\"cl-e0e4a2ba\"><p class=\"cl-e0e49126\"><span class=\"cl-e0e27242\">2,744</span></p></td><td class=\"cl-e0e4a2ba\"><p class=\"cl-e0e49126\"><span class=\"cl-e0e27242\">4</span></p></td><td class=\"cl-e0e4a2ba\"><p class=\"cl-e0e49126\"><span class=\"cl-e0e27242\"></span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-e0e4a2b1\"><p class=\"cl-e0e4911c\"><span class=\"cl-e0e27242\">`Asir</span></p></td><td class=\"cl-e0e4a2b1\"><p class=\"cl-e0e4911c\"><span class=\"cl-e0e27242\">[ 20, 25)</span></p></td><td class=\"cl-e0e4a2ba\"><p class=\"cl-e0e49126\"><span class=\"cl-e0e27242\"></span></p></td><td class=\"cl-e0e4a2ba\"><p class=\"cl-e0e49126\"><span class=\"cl-e0e27242\">79</span></p></td><td class=\"cl-e0e4a2ba\"><p class=\"cl-e0e49126\"><span class=\"cl-e0e27242\"></span></p></td><td class=\"cl-e0e4a2ba\"><p class=\"cl-e0e49126\"><span class=\"cl-e0e27242\"></span></p></td><td class=\"cl-e0e4a2ba\"><p class=\"cl-e0e49126\"><span class=\"cl-e0e27242\">25</span></p></td><td class=\"cl-e0e4a2ba\"><p class=\"cl-e0e49126\"><span class=\"cl-e0e27242\"></span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-e0e4a2c4\"><p class=\"cl-e0e4911c\"><span class=\"cl-e0e27242\">`Asir</span></p></td><td class=\"cl-e0e4a2c4\"><p class=\"cl-e0e4911c\"><span class=\"cl-e0e27242\">[ 25, 30)</span></p></td><td class=\"cl-e0e4a2c5\"><p class=\"cl-e0e49126\"><span class=\"cl-e0e27242\">1</span></p></td><td class=\"cl-e0e4a2c5\"><p class=\"cl-e0e49126\"><span class=\"cl-e0e27242\">76</span></p></td><td class=\"cl-e0e4a2c5\"><p class=\"cl-e0e49126\"><span class=\"cl-e0e27242\"></span></p></td><td class=\"cl-e0e4a2c5\"><p class=\"cl-e0e49126\"><span class=\"cl-e0e27242\">21</span></p></td><td class=\"cl-e0e4a2c5\"><p class=\"cl-e0e49126\"><span class=\"cl-e0e27242\">22</span></p></td><td class=\"cl-e0e4a2c5\"><p class=\"cl-e0e49126\"><span class=\"cl-e0e27242\"></span></p></td></tr></tbody></table></div>\n```\n\n:::\n:::\n\n\n### Mapping health directorates to regions for smoking data\n\nThe smoking data provided is clinic based data disaggregated at the\nlevel of health directorate. There are 20 directorates in KSA, and 13\nregions.\n\nAvailable population data is at regional level, so to generate\npopulation denominators for the smoking data I have mapped directorates\nto regions as follows:\n\n-   I used a dataset which contained spatial locations of healthcare\n    facilities (smoking cessation clinics) at health directorate\n    level[^getting-started-3]\n\n-   For each location I extracted spatial coordinates (longitude and\n    latitude)\n\n-   I obtained a regional boundary file (shape file) from\n    <https://data.humdata.org/dataset/41ce9023-1d21-4549-a485-94316200aba0/resource/99834c81-ad34-415e-91c5-af053d8e55b4/download/sau_capp_adm1_1m_ocha.zip>\n\n-   I spatially joined the clinic location and boundary files (see\n    @fig-map)\n\n-   This created a lookup table for directorates and regions and enabled\n    the smoking data to be recoded to regions and calculation of rates\n    using the census regional population estimates\n\n[^getting-started-3]: [https://www.moh.gov.sa/en/Ministry/Projects/TCP/Pages/default.aspx](https://www.moh.gov.sa/en/Ministry/Projects/TCP/Pages/default.aspx\")\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsc_ll_sf |>\n    ggplot() +\n    geom_sf(data = sa_bound) +\n    geom_sf(aes(colour = name)) \n```\n\n::: {.cell-output-display}\n![Location map of smoking clinics mapped to KSA regional boundaries](getting-started_files/figure-html/fig-map-1.png){#fig-map width=672}\n:::\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"site_libs/tabwid-1.1.3/tabwid.css\" rel=\"stylesheet\" />\n<script src=\"site_libs/tabwid-1.1.3/tabwid.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}